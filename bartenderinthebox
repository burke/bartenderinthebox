#!/usr/bin/env ruby
# -*- ruby -*-

BTB_ROOT = File.dirname(__FILE__)

require 'rubygems'
require 'yaml'
require 'readline'
require 'logger'
require 'activerecord'

Dir.glob("#{BTB_ROOT}/models/*.rb").map{ |file| require file }
ActiveRecord::Base.establish_connection(YAML.load(open("#{BTB_ROOT}/data/database.yml")))

class BartenderInTheBox
  attr_reader :available_drinks

  def initialize
    $log = Logger.new(STDOUT)
    $log.level = Logger::DEBUG
    calculate_available_drinks
  end

  def calculate_available_drinks
    @available_drinks = Drink.find_available
  end

  def mix( id )
    drink = Drink.find(id)
    $log.info "Starting mixing of D##{id} (#{drink.name})"
    threads = []
    drink.recipe_items.each do |r_item|
      threads << Thread.new do
        reservoir = Reservoir.find_by_ingredient_id(r_item.ingredient_id)
        $log.debug "Activating Reservoir R##{reservoir.bay} for #{r_item.quantity} mL of I##{r_item.ingredient_id}."
        reservoir.dispense( r_item.quantity )
        $log.debug "Finished dispensing I##{r_item.ingredient_id}"
      end
    end
    threads.map{ |t| t.join }
    $log.info "Finished mixing D##{id} (#{drink.name})"
  end
end

if __FILE__ == $0
  require 'lib/cli_interface'
  CLI_INTERFACE::run
end
